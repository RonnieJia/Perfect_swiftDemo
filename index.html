<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Perfect swiftdemo by RonnieJia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Perfect swiftdemo</h1>
      <h2 class="project-tagline">Perfect项目上手Demo</h2>
      <a href="https://github.com/RonnieJia/Perfect_swiftDemo" class="btn">View on GitHub</a>
      <a href="https://github.com/RonnieJia/Perfect_swiftDemo/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/RonnieJia/Perfect_swiftDemo/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Project introduce</h3>

<p>该项目用perfect来测试swift用来开发服务端的demo，经简单测试可以实现GET、POST接口的定制。<!--<a href="https://guides.github.com/features/mastering-markdown/">using GitHub Flavored Markdown</a>--></p>
<code>
<pre>public func PerfectServerModuleInit() {
	
	Routing.Handler.registerGlobally()
    Routing.Routes["GET", ["/jph"]] = { (_:WebResponse) in return PerfectHandler() }
    print("\(Routing.Routes.description)")
    
    Routing.Routes["GET", ["/jph2"]] = { (_:WebResponse) in return RonnieHandler() }
    
    Routing.Routes["POST", "/user/{keyid}"] = { (_:WebResponse) in return Echo3Handler() }
    
    /** student */
    Routing.Routes["GET","api/students"] = {(_:WebResponse) in return StudentHandler() }
    
    /** class */
    Routing.Routes["GET","api/classes"] = {(_:WebResponse) in return StudentHandler() }
    
    /** grade
      * 参数1 c_id
      * 参数2 s_id
    */
    Routing.Routes["POST","api/grade"] = {(_:WebResponse) in return GradeHandler() }
}
</pre>
</code>
<p>实现方法,以GET为例</p>
<code><pre>
class ClassHandler: RequestHandler {
    func handleRequest(request: WebRequest, response: WebResponse) {
        response.addHeader("Content-Type", value: "application/json")
        response.addHeader("Content-Type", value: "text/html; charset=utf-8")
        
        let mysql = MySQL()
        let connect = mysql.connect(HOST,user: USER,password: PASSWORD)
        if (connect) {
            let sres = mysql.selectDatabase(SCHEME)
            if (sres) {
                let sres2 = mysql.query("SELECT c_name,c_id FROM class")
                if (sres2) {
                    let results = mysql.storeResults()!
                    if (results.numRows() == 0) {
                        do {
                            let encode = JSONEncoder()
                            let data = try encode.encode(["result":"","success":false,"returnMessae":"could not create data"])
                            response.appendBodyString(data)
                        }
                            
                        catch {
                            response.setStatus(500, message: "Could not create data")
                        }
                    } else {
                        var dataArray:Array<AnyObject> = []
                        var dict = Dictionary<String,String>()
                        while let row = results.next() {
                            dict["s_name"] = row[0];
                            dict["s_id"] = row[1];
                            dataArray.append(dict)
                        }
                        print(NSJSONSerialization.isValidJSONObject(dataArray))
                        
                        do {
                            var dict = Dictionary<String,AnyObject>()
                            dict["result"] = dataArray
                            dict["success"] = true
                            dict["returnMessage"]=""
                            let dataFinal = try NSJSONSerialization.dataWithJSONObject(dict, options: NSJSONWritingOptions(rawValue: 0))
                            let string = NSString(data: dataFinal, encoding: NSUTF8StringEncoding)
                            let tee:String = string as! String
                            response.appendBodyString(tee)
                        }
                        catch {
                            response.setStatus(500, message: "Could not create data")
                        }
                    }
                    results.close()
                }
            }
            mysql.close()
        }
        response.requestCompletedCallback()
    } 
}

</pre></code>
<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Perfect Project</h3>

<p>开发环境以及类库的导入可以参照 <a href="http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=402331193&idx=1&sn=dc07b803ef9377965f5a5092cc37ccab#rd">Swift服务端编程：Perfect项目上手指南</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/RonnieJia/Perfect_swiftDemo">Perfect swiftdemo</a> is maintained by <a href="https://github.com/RonnieJia">RonnieJia</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
